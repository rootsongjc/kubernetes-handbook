# Kubernetesä¸äº‘åŸç”Ÿåº”ç”¨æ¦‚è§ˆ

å‡ ä¸ªæœˆå‰Mesoså·²ç»å®£å¸ƒæ”¯æŒKubernetesï¼Œè€Œåœ¨2017å¹´10æœˆä»½çš„DockerCon EUä¸Šï¼ŒDockerå…¬å¸å®£å¸ƒå®˜æ–¹åŒæ—¶æ”¯æŒSwarmå’ŒKuberneteså®¹å™¨ç¼–æ’ï¼ŒKuberneteså·²ç„¶æˆä¸ºå®¹å™¨ç¼–æ’è°ƒåº¦çš„æ ‡å‡†ã€‚

ä½œä¸ºå…¨ä¹¦çš„å¼€å¤´ï¼Œé¦–å…ˆä»å†å²ã€ç”Ÿæ€å’Œåº”ç”¨è§’åº¦ä»‹ç»ä¸€ä¸‹Kubernetesä¸äº‘åŸç”Ÿåº”ç”¨ï¼Œæ·±å…¥æµ…å‡ºï¼Œé«˜å±‹å»ºç“´ï¼Œæ²¡æœ‰æ·±å…¥åˆ°å…·ä½“ç»†èŠ‚ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç»™åˆæ¬¡æ¥è§¦Kubernetesçš„å°ç™½æ‰«ç›²ï¼Œå…·ä½“ç»†èŠ‚è¯·å‚è€ƒé“¾æ¥ã€‚

## ä»äº‘è®¡ç®—åˆ°å¾®æœåŠ¡å†åˆ°äº‘åŸç”Ÿè®¡ç®—

ä¸‹é¢å°†ä»äº‘è®¡ç®—çš„å‘å±•å†ç¨‹å¼•å…¥äº‘åŸç”Ÿè®¡ç®—ï¼Œè¯·å…ˆçœ‹ä¸‹å›¾ï¼š

![äº‘è®¡ç®—æ¼”è¿›å†ç¨‹](../images/cloud-computing-evolution-road.jpg)

äº‘åŸç”Ÿåº”ç”¨åˆ°2020å¹´å°†æ¯”ç›®å‰è‡³å°‘ç¿»ä¸€ç•ªï¼Œä¸‹å›¾æ˜¯Marc Wilczekçš„è°ƒæŸ¥æŠ¥å‘Šã€‚

![æ¥è‡ªTwitter @MarcWilczek](../images/cloud-native-comes-of-age.jpg)

### äº‘è®¡ç®—ä»‹ç»

äº‘è®¡ç®—åŒ…å«çš„å†…å®¹ååˆ†ç¹æ‚ï¼Œä¹Ÿæœ‰å¾ˆå¤šæŠ€æœ¯å’Œå…¬å¸ç‰µå¼ºé™„ä¼šè¯´è‡ªå·±æ˜¯äº‘è®¡ç®—å…¬å¸ï¼Œè¯´è‡ªå·±æ˜¯åšäº‘çš„ï¼Œå®é™…ä¸Šå¯èƒ½é£é©¬ç‰›ä¸ç›¸åŠã€‚è¯´ç™½äº†ï¼Œäº‘è®¡ç®—å°±æ˜¯ä¸€ç§é…ç½®èµ„æºçš„æ–¹å¼ï¼Œæ ¹æ®èµ„æºé…ç½®æ–¹å¼çš„ä¸åŒæˆ‘ä»¬å¯ä»¥æŠŠäº‘è®¡ç®—ä»å®è§‚ä¸Šåˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š

* IaaSï¼šè¿™æ˜¯ä¸ºäº†æƒ³è¦å»ºç«‹è‡ªå·±çš„å•†ä¸šæ¨¡å¼å¹¶è¿›è¡Œè‡ªå®šä¹‰çš„å®¢æˆ·ï¼Œä¾‹å¦‚äºšé©¬é€Šçš„EC2ã€S3å­˜å‚¨ã€Rackspaceè™šæ‹Ÿæœºç­‰éƒ½æ˜¯IaaSã€‚
* PaaSï¼šå·¥å…·å’ŒæœåŠ¡çš„é›†åˆï¼Œå¯¹äºæƒ³ç”¨å®ƒæ¥æ„å»ºè‡ªå·±çš„åº”ç”¨ç¨‹åºæˆ–è€…æƒ³å¿«é€Ÿå¾—å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒè€Œä¸å¿…å…³å¿ƒåº•å±‚ç¡¬ä»¶çš„ç”¨æˆ·å’Œå¼€å‘è€…æ¥è¯´æ˜¯ç‰¹åˆ«æœ‰ç”¨çš„ï¼Œæ¯”å¦‚Cloud Foundryã€Google App Engineã€Herokuç­‰ã€‚
* SaaSï¼šç»ˆç«¯ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨çš„åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªå°±å¤ªå¤šï¼Œæˆ‘ä»¬ç”Ÿæ´»ä¸­ç”¨åˆ°çš„å¾ˆå¤šè½¯ä»¶éƒ½æ˜¯SaaSæœåŠ¡ï¼Œåªè¦åŸºäºäº’è”ç½‘æ¥æä¾›çš„æœåŠ¡åŸºæœ¬éƒ½æ˜¯SaaSæœåŠ¡ï¼Œæœ‰çš„æœåŠ¡æ˜¯å…è´¹çš„ï¼Œæ¯”å¦‚Google Docsï¼Œè¿˜æœ‰æ›´å¤šçš„æ˜¯æ ¹æ®æˆ‘ä»¬è´­ä¹°çš„Planå’Œä½¿ç”¨é‡ä»˜è´¹ï¼Œæ¯”å¦‚GitHubã€å„ç§äº‘å­˜å‚¨ã€‚

### å¾®æœåŠ¡ä»‹ç»

å¾®æœåŠ¡ï¼ˆMicroservicesï¼‰è¿™ä¸ªè¯æ¯”è¾ƒæ–°é¢–ï¼Œä½†æ˜¯å…¶å®è¿™ç§æ¶æ„è®¾è®¡ç†å¿µæ—©å°±æœ‰äº†ã€‚å¾®æœåŠ¡æ˜¯ä¸€ç§åˆ†å¸ƒå¼æ¶æ„è®¾è®¡ç†å¿µï¼Œä¸ºäº†æ¨åŠ¨ç»†ç²’åº¦æœåŠ¡çš„ä½¿ç”¨ï¼Œè¿™äº›æœåŠ¡è¦èƒ½ååŒå·¥ä½œï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸€ä¸ªå¾®æœåŠ¡å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å®ä½“ï¼Œå¯ä»¥ç‹¬ç«‹çš„éƒ¨ç½²åœ¨PAASå¹³å°ä¸Šï¼Œä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹åœ¨ä¸»æœºä¸­è¿è¡Œã€‚æœåŠ¡ä¹‹é—´é€šè¿‡APIè®¿é—®ï¼Œä¿®æ”¹ä¸€ä¸ªæœåŠ¡ä¸ä¼šå½±å“å…¶å®ƒæœåŠ¡ã€‚

è¦æƒ³äº†è§£å¾®æœåŠ¡çš„è¯¦ç»†å†…å®¹æ¨èé˜…è¯»ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹ï¼ˆSam Newmanè‘—ï¼‰ï¼Œæˆ‘å†™è¿‡è¿™æœ¬ä¹¦çš„è¯»ä¹¦ç¬”è®° - [å¾®æœåŠ¡è®¾è®¡è¯»ä¹¦ç¬”è®°](https://jimmysong.io/posts/microservice-reading-notes/)ã€‚

ä¸‹æ–‡ä¸­ä¼šè°ˆåˆ°Kubernetesä¸å¾®æœåŠ¡çš„å…³ç³»ï¼Œå…¶ä¸­Kubernetesçš„serviceå¤©ç”Ÿå°±é€‚åˆäºå¾®æœåŠ¡ã€‚

### äº‘åŸç”Ÿæ¦‚å¿µä»‹ç»

ä¸‹é¢æ˜¯Cloud Nativeæ¦‚å¿µæ€ç»´å¯¼å›¾

![Cloud nativeæ€ç»´å¯¼å›¾](../images/cloud-native-architecutre-mindnode.jpg)

äº‘åŸç”Ÿå‡†ç¡®æ¥è¯´æ˜¯ä¸€ç§æ–‡åŒ–ï¼Œæ›´æ˜¯ä¸€ç§æ½®æµï¼Œå®ƒæ˜¯äº‘è®¡ç®—çš„ä¸€ä¸ªå¿…ç„¶å¯¼å‘ã€‚å®ƒçš„æ„ä¹‰åœ¨äºè®©äº‘æˆä¸ºäº‘åŒ–æˆ˜ç•¥æˆåŠŸçš„åŸºçŸ³ï¼Œè€Œä¸æ˜¯é˜»ç¢ï¼Œå¦‚æœä¸šåŠ¡åº”ç”¨ä¸Šäº‘ä¹‹åå¼€å‘å’Œè¿ç»´äººå‘˜æ¯”åŸå…ˆè¿˜ç—›è‹¦ï¼Œæˆæœ¬è¿˜é«˜çš„è¯ï¼Œè¿™æ ·çš„äº‘æˆ‘ä»¬å®æ„¿ä¸ä¸Šã€‚

è‡ªä»äº‘çš„æ¦‚å¿µå¼€å§‹æ™®åŠï¼Œè®¸å¤šå…¬å¸éƒ½éƒ¨ç½²äº†å®æ–½äº‘åŒ–çš„ç­–ç•¥ï¼Œçº·çº·æ­å»ºèµ·äº‘å¹³å°ï¼Œå¸Œæœ›å®Œæˆä¼ ç»Ÿåº”ç”¨åˆ°äº‘ç«¯çš„è¿ç§»ã€‚ä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šé‡åˆ°ä¸€äº›æŠ€æœ¯éš¾é¢˜ï¼Œä¸Šäº‘ä»¥åï¼Œæ•ˆç‡å¹¶æ²¡æœ‰å˜å¾—æ›´é«˜ï¼Œæ•…éšœä¹Ÿæ²¡æœ‰è¿…é€Ÿå®šä½ã€‚

ä¸ºäº†è§£å†³ä¼ ç»Ÿåº”ç”¨å‡çº§ç¼“æ…¢ã€æ¶æ„è‡ƒè‚¿ã€ä¸èƒ½å¿«é€Ÿè¿­ä»£ã€æ•…éšœä¸èƒ½å¿«é€Ÿå®šä½ã€é—®é¢˜æ— æ³•å¿«é€Ÿè§£å†³ç­‰é—®é¢˜ï¼Œäº‘åŸç”Ÿè¿™ä¸€æ¦‚å¿µæ¨ªç©ºå‡ºä¸–ã€‚äº‘åŸç”Ÿå¯ä»¥æ”¹è¿›åº”ç”¨å¼€å‘çš„æ•ˆç‡ï¼Œæ”¹å˜ä¼ä¸šçš„ç»„ç»‡ç»“æ„ï¼Œç”šè‡³ä¼šåœ¨æ–‡åŒ–å±‚é¢ä¸Šç›´æ¥å½±å“ä¸€ä¸ªå…¬å¸çš„å†³ç­–ã€‚

å¦å¤–ï¼Œäº‘åŸç”Ÿä¹Ÿå¾ˆå¥½åœ°è§£é‡Šäº†äº‘ä¸Šè¿è¡Œçš„åº”ç”¨åº”è¯¥å…·å¤‡ä»€ä¹ˆæ ·çš„æ¶æ„ç‰¹æ€§â€”â€”æ•æ·æ€§ã€å¯æ‰©å±•æ€§ã€æ•…éšœå¯æ¢å¤æ€§ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œäº‘åŸç”Ÿåº”ç”¨åº”è¯¥å…·å¤‡ä»¥ä¸‹å‡ ä¸ªå…³é”®è¯ï¼š

* æ•æ·
* å¯é 
* é«˜å¼¹æ€§
* æ˜“æ‰©å±•
* æ•…éšœéš”ç¦»ä¿æŠ¤
* ä¸ä¸­æ–­ä¸šåŠ¡æŒç»­æ›´æ–°

ä»¥ä¸Šç‰¹æ€§ä¹Ÿæ˜¯äº‘åŸç”ŸåŒºåˆ«äºä¼ ç»Ÿäº‘åº”ç”¨çš„ä¼˜åŠ¿ç‰¹ç‚¹ã€‚

ä»å®è§‚æ¦‚å¿µä¸Šè®²ï¼Œäº‘åŸç”Ÿæ˜¯ä¸åŒæ€æƒ³çš„é›†åˆï¼Œé›†ç›®å‰å„ç§çƒ­é—¨æŠ€æœ¯ä¹‹å¤§æˆï¼Œå…·ä½“åŒ…æ‹¬å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å‡ ä¸ªéƒ¨åˆ†ã€‚

## Kubernetesä¸äº‘åŸç”Ÿçš„å…³ç³»

Kuberenteså¯ä»¥è¯´æ˜¯ä¹˜ç€Dockerå’Œå¾®æœåŠ¡çš„ä¸œé£ï¼Œä¸€ç»æ¨å‡ºä¾¿è¿…é€Ÿè¹¿çº¢ï¼Œå®ƒçš„å¾ˆå¤šè®¾è®¡æ€æƒ³éƒ½å¥‘åˆäº†å¾®æœåŠ¡å’Œäº‘åŸç”Ÿåº”ç”¨çš„è®¾è®¡æ³•åˆ™ï¼Œè¿™å…¶ä¸­æœ€è‘—åçš„å°±æ˜¯å¼€å‘äº†[Heroku](https://www.heroku.com) PaaSå¹³å°çš„å·¥ç¨‹å¸ˆä»¬æ€»ç»“çš„ [Twelve-factor App](https://12factor.net/)äº†ã€‚

ä¸‹é¢æˆ‘å°†è®²è§£Kubernetesè®¾è®¡æ—¶æ˜¯å¦‚ä½•æŒ‰ç…§äº†åäºŒå› ç´ åº”ç”¨æ³•åˆ™ï¼Œå¹¶ç»™å‡ºKubernetesä¸­çš„åº”ç”¨ç¤ºä¾‹ï¼Œå¹¶é™„ä¸Šä¸€å¥è¯ç®€çŸ­çš„ä»‹ç»ã€‚

### Kubernetesä»‹ç»

[Kubernetes](http://kubernetes.io)æ˜¯GoogleåŸºäº[Borg](https://research.google.com/pubs/pub43438.html)å¼€æºçš„å®¹å™¨ç¼–æ’è°ƒåº¦å¼•æ“ï¼Œä½œä¸º[CNCF](http://cncf.io)ï¼ˆCloud Native Computing Foundationï¼‰æœ€é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒçš„ç›®æ ‡ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç¼–æ’ç³»ç»Ÿï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªè§„èŒƒï¼Œå¯ä»¥è®©ä½ æ¥æè¿°é›†ç¾¤çš„æ¶æ„ï¼Œå®šä¹‰æœåŠ¡çš„æœ€ç»ˆçŠ¶æ€ï¼ŒKuberneteså¯ä»¥å¸®ä½ å°†ç³»ç»Ÿè‡ªåŠ¨å¾—è¾¾åˆ°å’Œç»´æŒåœ¨è¿™ä¸ªçŠ¶æ€ã€‚

æ›´ç›´ç™½çš„è¯´ï¼ŒKubernetesç”¨æˆ·å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªyamlæˆ–è€…jsonæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å·¥å…·/ä»£ç ç”Ÿæˆæˆ–ç›´æ¥è¯·æ±‚Kubernetes APIåˆ›å»ºåº”ç”¨ï¼Œè¯¥é…ç½®æ–‡ä»¶ä¸­åŒ…å«äº†ç”¨æˆ·æƒ³è¦åº”ç”¨ç¨‹åºä¿æŒçš„çŠ¶æ€ï¼Œä¸è®ºæ•´ä¸ªKubernetesé›†ç¾¤ä¸­çš„ä¸ªåˆ«ä¸»æœºå‘ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Œéƒ½ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡æ”¹å˜è¯¥é…ç½®æ–‡ä»¶æˆ–è¯·æ±‚Kubernetes APIæ¥æ”¹å˜åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚

### 12å› ç´ åº”ç”¨

12å› ç´ åº”ç”¨æå‡ºå·²ç»æœ‰å‡ å¹´çš„æ—¶é—´äº†ï¼Œæ¯ä¸ªäººå¯¹å…¶å¯èƒ½éƒ½æœ‰è‡ªå·±çš„ç†è§£ï¼Œåˆ‡ä¸å¯ç”Ÿæ¬ç¡¬å¥—ï¼Œä¹Ÿä¸ä¸€å®šæ‰€æœ‰äº‘åŸç”Ÿåº”ç”¨éƒ½å¿…é¡»ç¬¦åˆè¿™12æ¡æ³•åˆ™ï¼Œå…¶ä¸­æœ‰å‡ æ¡æ³•åˆ™å¯èƒ½è¿˜æœ‰ç‚¹äº‰è®®ï¼Œæœ‰äººå¯¹å…¶çš„è§£é‡Šå’Œçœ‹æ³•ä¸åŒã€‚

å¤§å®¶ä¸è¦å­¤ç«‹çš„æ¥çœ‹è¿™æ¯ä¸€ä¸ªå› ç´ ï¼Œå°†å…¶ä¸è‡ªå·±è½¯ä»¶å¼€å‘æµç¨‹è”ç³»èµ·æ¥ï¼Œè¿™12ä¸ªå› ç´ å¤§è‡´å°±æ˜¯æŒ‰ç…§è½¯ä»¶ä»å¼€å‘åˆ°äº¤ä»˜çš„æµç¨‹é¡ºåºæ¥å†™çš„ã€‚

![åäºŒå› ç´ åº”ç”¨](../images/12-factor-app.png)

**1.åŸºå‡†ä»£ç **

æ¯ä¸ªä»£ç ä»“åº“ï¼ˆrepoï¼‰éƒ½ç”Ÿæˆdocker imageä¿å­˜åˆ°é•œåƒä»“åº“ä¸­ï¼Œå¹¶ä½¿ç”¨å”¯ä¸€çš„IDç®¡ç†ï¼Œåœ¨Jenkinsä¸­ä½¿ç”¨ç¼–è¯‘æ—¶çš„IDã€‚

**2.ä¾èµ–**

æ˜¾å¼çš„å£°æ˜ä»£ç ä¸­çš„ä¾èµ–ï¼Œä½¿ç”¨è½¯ä»¶åŒ…ç®¡ç†å·¥å…·å£°æ˜ï¼Œæ¯”å¦‚Goä¸­çš„Glideã€‚

**3.é…ç½®**

å°†é…ç½®ä¸ä»£ç åˆ†ç¦»ï¼Œåº”ç”¨éƒ¨ç½²åˆ°Kubernetesä¸­å¯ä»¥ä½¿ç”¨å®¹å™¨çš„ç¯å¢ƒå˜é‡æˆ–ConfigMapæŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚

**4.åç«¯æœåŠ¡**

æŠŠåç«¯æœåŠ¡å½“ä½œé™„åŠ èµ„æºï¼Œå®è´¨ä¸Šæ˜¯è®¡ç®—å­˜å‚¨åˆ†ç¦»å’Œé™ä½æœåŠ¡è€¦åˆï¼Œåˆ†è§£å•ä½“åº”ç”¨ã€‚

**5.æ„å»ºã€å‘å¸ƒã€è¿è¡Œ**

ä¸¥æ ¼åˆ†ç¦»æ„å»ºå’Œè¿è¡Œï¼Œæ¯æ¬¡ä¿®æ”¹ä»£ç ç”Ÿæˆæ–°çš„é•œåƒï¼Œé‡æ–°å‘å¸ƒï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶çš„ä»£ç å’Œé…ç½®ã€‚

**6.è¿›ç¨‹**

åº”ç”¨ç¨‹åºè¿›ç¨‹åº”è¯¥æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿™æ„å‘³ç€å†æ¬¡é‡å¯åè¿˜å¯ä»¥è®¡ç®—å‡ºåŸå…ˆçš„çŠ¶æ€ã€‚

**7.ç«¯å£ç»‘å®š**

åœ¨Kubernetesä¸­æ¯ä¸ªPodéƒ½æœ‰ç‹¬ç«‹çš„IPï¼Œæ¯ä¸ªè¿è¡Œåœ¨Podä¸­çš„åº”ç”¨ä¸å¿…å…³å¿ƒç«¯å£æ˜¯å¦é‡å¤ï¼Œåªéœ€åœ¨serviceä¸­æŒ‡å®šç«¯å£ï¼Œé›†ç¾¤å†…çš„serviceé€šè¿‡é…ç½®äº’ç›¸å‘ç°ã€‚

**8.å¹¶å‘**

æ¯ä¸ªå®¹å™¨éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œé€šè¿‡å¢åŠ å®¹å™¨çš„å‰¯æœ¬æ•°å®ç°å¹¶å‘ã€‚

**9.æ˜“å¤„ç†**

å¿«é€Ÿå¯åŠ¨å’Œä¼˜é›…ç»ˆæ­¢å¯æœ€å¤§åŒ–å¥å£®æ€§ï¼ŒKuberentesä¼˜ç§€çš„[Podç”Ÿå­˜å‘¨æœŸæ§åˆ¶](https://jimmysong.io/posts/pod-lifecycle/)ã€‚

**10.å¼€å‘ç¯å¢ƒä¸çº¿ä¸Šç¯å¢ƒç­‰ä»·**

åœ¨Kubernetesä¸­å¯ä»¥åˆ›å»ºå¤šä¸ªnamespaceï¼Œä½¿ç”¨ç›¸åŒçš„é•œåƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¤åˆ¶ä¸€å¥—ç¯å¢ƒå‡ºæ¥ï¼Œé•œåƒçš„ä½¿ç”¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„éƒ¨ç½²ä¸€ä¸ªåç«¯æœåŠ¡ã€‚

**11.æ—¥å¿—**

æŠŠæ—¥å¿—å½“ä½œäº‹ä»¶æµï¼Œä½¿ç”¨stdoutè¾“å‡ºå¹¶æ”¶é›†æ±‡èšèµ·æ¥ï¼Œä¾‹å¦‚åˆ°ESä¸­ç»Ÿä¸€æŸ¥çœ‹ã€‚

**12.ç®¡ç†è¿›ç¨‹**

åå°ç®¡ç†ä»»åŠ¡å½“ä½œä¸€æ¬¡æ€§è¿›ç¨‹è¿è¡Œï¼Œ`kubectl exec`è¿›å…¥å®¹å™¨å†…éƒ¨æ“ä½œã€‚

å¦å¤–ï¼Œ[Cloud Native Go](https://jimmysong.io/cloud-native-go) è¿™æœ¬ä¹¦çš„ä½œè€…ï¼ŒCapitalOneå…¬å¸çš„Kevin Hoffmanåœ¨TalkingData T11å³°ä¼šä¸Šçš„[High Level Cloud Native](https://jimmysong.io/posts/high-level-cloud-native-from-kevin-hoffman/)çš„æ¼”è®²ä¸­è®²è¿°äº†äº‘åŸç”Ÿåº”ç”¨çš„15ä¸ªå› ç´ ï¼Œåœ¨åŸå…ˆçš„12å› ç´ åº”ç”¨çš„åŸºç¡€ä¸Šåˆå¢åŠ äº†å¦‚ä¸‹ä¸‰ä¸ªå› ç´ ï¼š

**APIä¼˜å…ˆ**

* æœåŠ¡é—´çš„åˆçº¦
* å›¢é˜Ÿåä½œçš„è§„çº¦
* æ–‡æ¡£åŒ–ã€è§„èŒƒåŒ–
* RESTfulæˆ–RPC

**ç›‘æ§**

* å®æ—¶ç›‘æ§è¿œç¨‹åº”ç”¨
* åº”ç”¨æ€§èƒ½ç›‘æ§ï¼ˆAPMï¼‰
* åº”ç”¨å¥åº·ç›‘æ§
* ç³»ç»Ÿæ—¥å¿—
* ä¸å»ºè®®åœ¨çº¿Debug

**è®¤è¯æˆæƒ**

* ä¸è¦ç­‰æœ€åæ‰å»è€ƒè™‘åº”ç”¨çš„å®‰å…¨æ€§
* è¯¦ç»†è®¾è®¡ã€æ˜ç¡®å£°æ˜ã€æ–‡æ¡£åŒ–
* Bearer tokenã€OAuthã€OIDCè®¤è¯
* æ“ä½œå®¡è®¡

è¯¦è§[High Level Cloud Native From Kevin Hoffman](https://jimmysong.io/posts/high-level-cloud-native-from-kevin-hoffman/)ã€‚

## Kubernetesä¸­çš„èµ„æºç®¡ç†ä¸å®¹å™¨è®¾è®¡æ¨¡å¼

Kubernetesé€šè¿‡å£°æ˜å¼é…ç½®ï¼ŒçœŸæ­£è®©å¼€å‘äººå‘˜èƒ½å¤Ÿç†è§£åº”ç”¨çš„çŠ¶æ€ï¼Œå¹¶é€šè¿‡åŒä¸€ä»½é…ç½®å¯ä»¥ç«‹é©¬å¯åŠ¨ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„ç¯å¢ƒï¼Œå¤§å¤§æé«˜äº†åº”ç”¨å¼€å‘å’Œéƒ¨ç½²çš„æ•ˆç‡ï¼Œå…¶ä¸­Kubernetesè®¾è®¡çš„å¤šç§èµ„æºç±»å‹å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®šä¹‰åº”ç”¨çš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶ä½¿ç”¨èµ„æºé…ç½®æ¥ç»†ç²’åº¦çš„æ˜ç¡®é™åˆ¶åº”ç”¨çš„èµ„æºä½¿ç”¨ã€‚

è€Œå®¹å™¨ç”Ÿæ€çš„æˆç†Ÿæ˜¯ Kubernetes è¯ç”Ÿçš„å‰æï¼Œåœ¨è°ˆåˆ°å®¹å™¨çš„è®¾è®¡æ¨¡å¼ä¹‹å‰æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹å®¹å™¨ç”Ÿæ€ï¼Œè¯·çœ‹ä¸‹å›¾ï¼š

![å®¹å™¨ç”Ÿæ€](../images/container-ecosystem.png)

å…³äº Docker å®¹å™¨çš„æ›´å¤šå†…å®¹è¯·å‚è€ƒ [Dockeræœ€ä½³å®è·µ](../appendix/docker-best-practice.md)ã€‚

### å®¹å™¨çš„è®¾è®¡æ¨¡å¼

Kubernetesæä¾›äº†å¤šç§èµ„æºå¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±åº”ç”¨çš„ç‰¹æ€§åŠ ä»¥é€‰æ‹©ã€‚è¿™äº›å¯¹è±¡æœ‰ï¼š

| ç±»åˆ« | åç§° |
| :--- | --- |
| èµ„æºå¯¹è±¡ | Podã€ReplicaSetã€ReplicationControllerã€Deploymentã€StatefulSetã€DaemonSetã€Jobã€CronJobã€HorizontalPodAutoscaler |
| é…ç½®å¯¹è±¡ | Nodeã€Namespaceã€Serviceã€Secretã€ConfigMapã€Ingressã€Labelã€CustomResourceDefinitionã€   ServiceAccount |
| å­˜å‚¨å¯¹è±¡ | Volumeã€Persistent Volume |
| ç­–ç•¥å¯¹è±¡ | SecurityContextã€ResourceQuotaã€LimitRange |

åœ¨ Kubernetes ç³»ç»Ÿä¸­ï¼Œ_Kubernetes å¯¹è±¡_ æ˜¯æŒä¹…åŒ–çš„æ¡ç›®ã€‚Kubernetes ä½¿ç”¨è¿™äº›æ¡ç›®å»è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ã€‚ç‰¹åˆ«åœ°ï¼Œå®ƒä»¬æè¿°äº†å¦‚ä¸‹ä¿¡æ¯ï¼š

* ä»€ä¹ˆå®¹å™¨åŒ–åº”ç”¨åœ¨è¿è¡Œï¼ˆä»¥åŠåœ¨å“ªä¸ª Node ä¸Šï¼‰
* å¯ä»¥è¢«åº”ç”¨ä½¿ç”¨çš„èµ„æº
* å…³äºåº”ç”¨å¦‚ä½•è¡¨ç°çš„ç­–ç•¥ï¼Œæ¯”å¦‚é‡å¯ç­–ç•¥ã€å‡çº§ç­–ç•¥ï¼Œä»¥åŠå®¹é”™ç­–ç•¥

Kubernetes å¯¹è±¡æ˜¯ â€œç›®æ ‡æ€§è®°å½•â€ â€”â€” ä¸€æ—¦åˆ›å»ºå¯¹è±¡ï¼ŒKubernetes ç³»ç»Ÿå°†æŒç»­å·¥ä½œä»¥ç¡®ä¿å¯¹è±¡å­˜åœ¨ã€‚é€šè¿‡åˆ›å»ºå¯¹è±¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å‘ŠçŸ¥ Kubernetes ç³»ç»Ÿï¼Œæ‰€éœ€è¦çš„é›†ç¾¤å·¥ä½œè´Ÿè½½çœ‹èµ·æ¥æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œè¿™å°±æ˜¯ Kubernetes é›†ç¾¤çš„ **æœŸæœ›çŠ¶æ€**ã€‚

è¯¦è§[Kubernetes Handbook - Objects](https://jimmysong.io/kubernetes-handbook/concepts/objects.html)ã€‚

### èµ„æºé™åˆ¶ä¸é…é¢

ä¸¤å±‚çš„èµ„æºé™åˆ¶ä¸é…ç½®

* Podçº§åˆ«ï¼Œæœ€å°çš„èµ„æºè°ƒåº¦å•ä½
* Namespaceçº§åˆ«ï¼Œé™åˆ¶èµ„æºé…é¢å’Œæ¯ä¸ªPodçš„èµ„æºä½¿ç”¨åŒºé—´

è¯·å‚è€ƒ[Kubernetesä¸­çš„ResourceQuotaå’ŒLimitRangeé…ç½®èµ„æºé™é¢](https://jimmysong.io/posts/kubernetes-resourcequota-limitrange-management/)

## ç®¡ç†Kubernetesé›†ç¾¤

æ‰‹å·¥éƒ¨ç½²Kubernetesæ˜¯ä¸€ä¸ªå¾ˆè‰°å·¨çš„æ´»ï¼Œä½ éœ€è¦äº†è§£ç½‘ç»œé…ç½®ã€Dockerçš„å®‰è£…ä¸ä½¿ç”¨ã€é•œåƒä»“åº“çš„æ„å»ºã€è§’è‰²è¯ä¹¦çš„åˆ›å»ºã€Kubernetesçš„åŸºæœ¬åŸç†å’Œæ„æˆã€Kubernetesåº”ç”¨ç¨‹åºçš„yamlæ–‡ä»¶ç¼–å†™ç­‰ã€‚

æˆ‘ç¼–å†™äº†ä¸€æœ¬[kubernetes-handbook](https://jimmysong.io/kubernetes-handbook/)å¯ä¾›å¤§å®¶å…è´¹é˜…è¯»ï¼Œè¯¥ä¹¦è®°å½•äº†æœ¬äººä»é›¶å¼€å§‹å­¦ä¹ å’Œä½¿ç”¨Kubernetesçš„å¿ƒè·¯å†ç¨‹ï¼Œç€é‡äºç»éªŒåˆ†äº«å’Œæ€»ç»“ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰ç›¸å…³çš„æ¦‚å¿µè§£æï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¤§å®¶å°‘è¸©å‘ï¼Œå°‘èµ°å¼¯è·¯ã€‚

### éƒ¨ç½²Kubernetesé›†ç¾¤

ä½¿ç”¨äºŒè¿›åˆ¶éƒ¨ç½² `kubernetes` é›†ç¾¤çš„æ‰€æœ‰ç»„ä»¶å’Œæ’ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `kubeadm` ç­‰è‡ªåŠ¨åŒ–æ–¹å¼æ¥éƒ¨ç½²é›†ç¾¤ï¼ŒåŒæ—¶å¼€å¯äº†é›†ç¾¤çš„TLSå®‰å…¨è®¤è¯ï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ç³»ç»Ÿå„ç»„ä»¶çš„äº¤äº’åŸç†ï¼Œè¿›è€Œèƒ½å¿«é€Ÿè§£å†³å®é™…é—®é¢˜ã€‚è¯¦è§[åœ¨CentOSä¸Šéƒ¨ç½²Kubernetesé›†ç¾¤](../practice/install-kubernetes-on-centos.md)ã€‚

**é›†ç¾¤è¯¦æƒ…**

* Kubernetes 1.6.0
* Docker 1.12.5ï¼ˆä½¿ç”¨yumå®‰è£…ï¼‰
* Etcd 3.1.5
* Flanneld 0.7 vxlan ç½‘ç»œ
* TLS è®¤è¯é€šä¿¡ \(æ‰€æœ‰ç»„ä»¶ï¼Œå¦‚ etcdã€kubernetes master å’Œ node\)
* RBAC æˆæƒ
* kubelet TLS BootStrapping
* kubednsã€dashboardã€heapster\(influxdbã€grafana\)ã€EFK\(elasticsearchã€fluentdã€kibana\) é›†ç¾¤æ’ä»¶
* ç§æœ‰Dockeré•œåƒä»“åº“[Harbor](https://github.com/vmware/harbor)ï¼ˆè¯·è‡ªè¡Œéƒ¨ç½²ï¼ŒHarboræä¾›ç¦»çº¿å®‰è£…åŒ…ï¼Œç›´æ¥ä½¿ç”¨docker-composeå¯åŠ¨å³å¯ï¼‰

**æ­¥éª¤ä»‹ç»**

1. [åˆ›å»º TLS è¯ä¹¦å’Œç§˜é’¥](../practice/create-tls-and-secret-key.md)
2. [åˆ›å»ºkubeconfigæ–‡ä»¶](../practice/create-kubeconfig.md)
3. [åˆ›å»ºé«˜å¯ç”¨etcdé›†ç¾¤](../practice/etcd-cluster-installation.md)
4. [å®‰è£…kubectlå‘½ä»¤è¡Œå·¥å…·](../practice/kubectl-installation.md)
5. [éƒ¨ç½²masterèŠ‚ç‚¹](../practice/master-installation.md)
6. [å®‰è£…flannelç½‘ç»œæ’ä»¶](../practice/flannel-installation.md)
7. [éƒ¨ç½²nodeèŠ‚ç‚¹](../practice/node-installation.md)
8. [å®‰è£…kubednsæ’ä»¶](../practice/kubedns-addon-installation.md)
9. [å®‰è£…dashboardæ’ä»¶](../practice/dashboard-addon-installation.md)
10. [å®‰è£…heapsteræ’ä»¶](../practice/heapster-addon-installation.md)
11. [å®‰è£…EFKæ’ä»¶](../practice/efk-addon-installation.md)

### æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡

Kubernetesåœ¨è®¾è®¡ä¹‹åˆå°±å……åˆ†è€ƒè™‘äº†é’ˆå¯¹å®¹å™¨çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œæä¾›äº†Serviceèµ„æºï¼Œå¹¶é€šè¿‡kube-proxyé…åˆcloud provideræ¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚éšç€Kubernetesç”¨æˆ·çš„æ¿€å¢ï¼Œç”¨æˆ·åœºæ™¯çš„ä¸æ–­ä¸°å¯Œï¼Œåˆäº§ç”Ÿäº†ä¸€äº›æ–°çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚ç›®å‰ï¼ŒKubernetesä¸­çš„è´Ÿè½½å‡è¡¡å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æœºåˆ¶ï¼Œæ¯ç§æœºåˆ¶éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ï¼š

* **Service**ï¼šç›´æ¥ç”¨Serviceæä¾›clusterå†…éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œå¹¶å€ŸåŠ©cloud provideræä¾›çš„LBæä¾›å¤–éƒ¨è®¿é—®
* **Ingress**ï¼šè¿˜æ˜¯ç”¨Serviceæä¾›clusterå†…éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œä½†æ˜¯é€šè¿‡è‡ªå®šä¹‰LBæä¾›å¤–éƒ¨è®¿é—®
* **Service Load Balancer**ï¼šæŠŠload balancerç›´æ¥è·‘åœ¨å®¹å™¨ä¸­ï¼Œå®ç°Bare Metalçš„Service Load Balancer
* **Custom Load Balancer**ï¼šè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ï¼Œå¹¶æ›¿ä»£kube-proxyï¼Œä¸€èˆ¬åœ¨ç‰©ç†éƒ¨ç½²Kubernetesæ—¶ä½¿ç”¨ï¼Œæ–¹ä¾¿æ¥å…¥å…¬å¸å·²æœ‰çš„å¤–éƒ¨æœåŠ¡

è¯¦è§[Kubernetes Handbook - æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡](https://jimmysong.io/kubernetes-handbook/practice/service-discovery-and-loadbalancing.html)ã€‚

### æŒç»­é›†æˆä¸å‘å¸ƒ

![ä½¿ç”¨Jenkinsè¿›è¡ŒæŒç»­é›†æˆä¸å‘å¸ƒæµç¨‹å›¾](../images/kubernetes-jenkins-ci-cd.png)

åº”ç”¨æ„å»ºå’Œå‘å¸ƒæµç¨‹è¯´æ˜ï¼š

1. ç”¨æˆ·å‘Gitlabæäº¤ä»£ç ï¼Œä»£ç ä¸­å¿…é¡»åŒ…å«`Dockerfile`
2. å°†ä»£ç æäº¤åˆ°è¿œç¨‹ä»“åº“
3. ç”¨æˆ·åœ¨å‘å¸ƒåº”ç”¨æ—¶éœ€è¦å¡«å†™gitä»“åº“åœ°å€å’Œåˆ†æ”¯ã€æœåŠ¡ç±»å‹ã€æœåŠ¡åç§°ã€èµ„æºæ•°é‡ã€å®ä¾‹ä¸ªæ•°ï¼Œç¡®å®šåè§¦å‘Jenkinsè‡ªåŠ¨æ„å»º
4. Jenkinsçš„CIæµæ°´çº¿è‡ªåŠ¨ç¼–è¯‘ä»£ç å¹¶æ‰“åŒ…æˆDockeré•œåƒæ¨é€åˆ°Harboré•œåƒä»“åº“
5. Jenkinsçš„CIæµæ°´çº¿ä¸­åŒ…æ‹¬äº†è‡ªå®šä¹‰è„šæœ¬ï¼Œæ ¹æ®æˆ‘ä»¬å·²å‡†å¤‡å¥½çš„Kubernetesçš„YAMLæ¨¡æ¿ï¼Œå°†å…¶ä¸­çš„å˜é‡æ›¿æ¢æˆç”¨æˆ·è¾“å…¥çš„é€‰é¡¹
6. ç”Ÿæˆåº”ç”¨çš„Kubernetes YAMLé…ç½®æ–‡ä»¶
7. æ›´æ–°Ingressçš„é…ç½®ï¼Œæ ¹æ®æ–°éƒ¨ç½²çš„åº”ç”¨çš„åç§°ï¼Œåœ¨Ingressçš„é…ç½®æ–‡ä»¶ä¸­å¢åŠ ä¸€æ¡è·¯ç”±ä¿¡æ¯
8. æ›´æ–°PowerDNSï¼Œå‘å…¶ä¸­æ’å…¥ä¸€æ¡DNSè®°å½•ï¼ŒIPåœ°å€æ˜¯è¾¹ç¼˜èŠ‚ç‚¹çš„IPåœ°å€ã€‚å…³äºè¾¹ç¼˜èŠ‚ç‚¹ï¼Œè¯·æŸ¥çœ‹[è¾¹ç¼˜èŠ‚ç‚¹é…ç½®](https://jimmysong.io/kubernetes-handbook/practice/edge-node-configuration.html)
9. Jenkinsè°ƒç”¨Kubernetesçš„APIï¼Œéƒ¨ç½²åº”ç”¨

### æ—¥å¿—æ”¶é›†ä¸ç›‘æ§

åŸºäºç°æœ‰çš„ELKæ—¥å¿—æ”¶é›†æ–¹æ¡ˆï¼Œç¨ä½œæ”¹é€ ï¼Œé€‰ç”¨[filebeat](https://www.elastic.co/products/beats/filebeat)æ¥æ”¶é›†æ—¥å¿—ï¼Œå¯ä»¥ä½œä¸ºsidecarçš„å½¢å¼è·Ÿåº”ç”¨è¿è¡Œåœ¨åŒä¸€ä¸ªPodä¸­ï¼Œæ¯”è¾ƒè½»é‡çº§æ¶ˆè€—èµ„æºæ¯”è¾ƒå°‘ã€‚

![filebeatæ—¥å¿—æ”¶é›†æ¶æ„å›¾](../images/filebeat-log-collector-arch.png)

è¯¦è§[Kubernetes Handbook - åº”ç”¨æ—¥å¿—æ”¶é›†](https://jimmysong.io/kubernetes-handbook/practice/app-log-collection.html)ã€‚

### å®‰å…¨æ€§ä¸æƒé™ç®¡ç†

Kubernetesæ˜¯ä¸€ä¸ªå¤šç§Ÿæˆ·çš„äº‘å¹³å°ï¼Œå› æ­¤å¿…é¡»å¯¹ç”¨æˆ·çš„æƒé™åŠ ä»¥é™åˆ¶ï¼Œå¯¹ç”¨æˆ·ç©ºé—´è¿›è¡Œéš”ç¦»ã€‚Kubernetesä¸­çš„éš”ç¦»ä¸»è¦åŒ…æ‹¬è¿™å‡ ç§ï¼š

* ç½‘ç»œéš”ç¦»ï¼šéœ€è¦ä½¿ç”¨ç½‘ç»œæ’ä»¶ï¼Œæ¯”å¦‚[flannel](https://coreos.com/flannel/), [calico](https://www.projectcalico.org/)ã€‚
* èµ„æºéš”ç¦»ï¼škubernetesåŸç”Ÿæ”¯æŒèµ„æºéš”ç¦»ï¼Œpodå°±æ˜¯èµ„æºéš”ç¦»å’Œè°ƒåº¦çš„æœ€å°å•ä½ï¼ŒåŒæ—¶ä½¿ç”¨[namespace](https://jimmysong.io/kubernetes-handbook/concepts/namespace.html)é™åˆ¶ç”¨æˆ·ç©ºé—´å’Œèµ„æºé™é¢ã€‚
* èº«ä»½éš”ç¦»ï¼šä½¿ç”¨[RBAC-åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶](https://jimmysong.io/kubernetes-handbook/guide/rbac.html)ï¼Œå¤šç§Ÿæˆ·çš„èº«ä»½è®¤è¯å’Œæƒé™æ§åˆ¶ã€‚

## å¦‚ä½•å¼€å‘KubernetesåŸç”Ÿåº”ç”¨æ­¥éª¤ä»‹ç»

å½“æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªkubernetesé›†ç¾¤åï¼Œå¦‚ä½•åœ¨ä¸Šé¢å¼€å‘å’Œéƒ¨ç½²åº”ç”¨ï¼Œåº”è¯¥éµå¾ªæ€æ ·çš„æµç¨‹ï¼Ÿä¸‹é¢æˆ‘å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨goè¯­è¨€å¼€å‘å’Œéƒ¨ç½²ä¸€ä¸ªKubernetes nativeåº”ç”¨ï¼Œä½¿ç”¨werckerè¿›è¡ŒæŒç»­é›†æˆä¸æŒç»­å‘å¸ƒï¼Œæˆ‘å°†ä»¥ä¸€ä¸ªå¾ˆç®€å•çš„å‰åç«¯è®¿é—®ï¼Œè·å–ä¼ªé€ æ•°æ®å¹¶å±•ç¤ºçš„ä¾‹å­æ¥è¯´æ˜ã€‚

### äº‘åŸç”Ÿåº”ç”¨å¼€å‘ç¤ºä¾‹

æˆ‘ä»¬å°†æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å¼€å‘éƒ¨ç½²ä¸€ä¸ªKubernetesåŸç”Ÿåº”ç”¨å¹¶å°†å®ƒéƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸Šå¼€æ”¾ç»™é›†ç¾¤å¤–è®¿é—®ï¼š

1. æœåŠ¡APIçš„å®šä¹‰
2. ä½¿ç”¨Goè¯­è¨€å¼€å‘KubernetesåŸç”Ÿåº”ç”¨
3. ä¸€ä¸ªæŒç»­æ„å»ºä¸å‘å¸ƒå·¥å…·ä¸ç¯å¢ƒ
4. ä½¿ç”¨traefikå’ŒVIPåšè¾¹ç¼˜èŠ‚ç‚¹æä¾›å¤–éƒ¨è®¿é—®è·¯ç”±

æˆ‘å†™äº†ä¸¤ä¸ªç¤ºä¾‹ç”¨äºæ¼”ç¤ºï¼Œå¼€å‘éƒ¨ç½²ä¸€ä¸ªä¼ªé€ çš„ metric å¹¶æ˜¾ç¤ºåœ¨ web é¡µé¢ä¸Šï¼ŒåŒ…æ‹¬ä¸¤ä¸ªserviceï¼š

* [k8s-app-monitor-test](https://github.com/rootsongjc/k8s-app-monitor-test)ï¼šç”Ÿæˆæ¨¡æ‹Ÿçš„ç›‘æ§æ•°æ®ï¼Œå‘é€httpè¯·æ±‚ï¼Œè·å–jsonè¿”å›å€¼
* [K8s-app-monitor-agent](https://github.com/rootsongjc/k8s-app-monitor-agent)ï¼šè·å–ç›‘æ§æ•°æ®å¹¶ç»˜å›¾ï¼Œè®¿é—®æµè§ˆå™¨è·å–å›¾è¡¨

**å®šä¹‰APIç”ŸæˆAPIæ–‡æ¡£**

ä½¿ç”¨`API blueprint`æ ¼å¼ï¼Œå®šä¹‰APIæ–‡æ¡£ï¼Œæ ¼å¼ç±»ä¼¼äºmarkdownï¼Œå†ä½¿ç”¨[aglio](https://github.com/danielgtaylor/aglio)ç”ŸæˆHTMLæ–‡æ¡£ã€‚

![APIæ–‡æ¡£](../images/k8s-app-monitor-test-api-doc.jpg)

è¯¦è§ï¼š[å¦‚ä½•å¼€å‘éƒ¨ç½²Kubernetes Nativeåº”ç”¨](https://jimmysong.io/posts/creating-cloud-native-app-with-kubernetes/)ã€‚

## å¦‚ä½•è¿ç§»åˆ°äº‘åŸç”Ÿåº”ç”¨æ¶æ„

[Pivotal](https://pivotal.io/) æ˜¯äº‘åŸç”Ÿåº”ç”¨çš„æå‡ºè€…ï¼Œå¹¶æ¨å‡ºäº† [Pivotal Cloud Foundry](https://pivotal.io/platform) äº‘åŸç”Ÿåº”ç”¨å¹³å°å’Œ [Spring](https://spring.io/) å¼€æº Java å¼€å‘æ¡†æ¶ï¼Œæˆä¸ºäº‘åŸç”Ÿåº”ç”¨æ¶æ„ä¸­å…ˆé©±è€…å’Œæ¢è·¯è€…ã€‚

åŸä¹¦ä½œäº2015å¹´ï¼Œå…¶ä¸­çš„ç¤ºä¾‹ä¸»è¦é’ˆå¯¹ Java åº”ç”¨ï¼Œå®é™…ä¸Šä¹Ÿé€‚ç”¨äºä»»ä½•åº”ç”¨ç±»å‹ï¼Œäº‘åŸç”Ÿåº”ç”¨æ¶æ„é€‚ç”¨äºå¼‚æ„è¯­è¨€çš„ç¨‹åºå¼€å‘ï¼Œä¸ä»…ä»…æ˜¯é’ˆå¯¹ Java è¯­è¨€çš„ç¨‹åºå¼€å‘ã€‚æˆªæ­¢åˆ°æœ¬äººç¿»è¯‘æœ¬ä¹¦æ—¶ï¼Œäº‘åŸç”Ÿåº”ç”¨ç”Ÿæ€ç³»ç»Ÿå·²ç»åˆå…·è§„æ¨¡ï¼Œ[CNCF](https://cncf.io/) æˆå‘˜ä¸æ–­å‘å±•å£®å¤§ï¼ŒåŸºäº Cloud Native çš„åˆ›ä¸šå…¬å¸ä¸æ–­æ¶Œç°ï¼Œ[kubernetes](https://kubernetes.io/) å¼•é¢†å®¹å™¨ç¼–æ’æ½®æµï¼Œå’Œ Service Mesh æŠ€æœ¯ï¼ˆå¦‚ [Linkerd](https://linkerd.io/) å’Œ [Istio](https://istio.io/)ï¼‰ çš„å‡ºç°ï¼ŒGo è¯­è¨€çš„å…´èµ·ï¼ˆå‚è€ƒå¦ä¸€æœ¬ä¹¦ [Cloud Native Go](http://rootsongjc.github.io/cloud-native-go)ï¼‰ç­‰ä¸ºæˆ‘ä»¬å°†åº”ç”¨è¿ç§»åˆ°äº‘åŸç”Ÿæ¶æ„çš„æä¾›äº†æ›´å¤šçš„æ–¹æ¡ˆé€‰æ‹©ã€‚

### è¿ç§»åˆ°äº‘åŸç”Ÿåº”ç”¨æ¶æ„æŒ‡å—

æŒ‡å‡ºäº†è¿ç§»åˆ°äº‘åŸç”Ÿåº”ç”¨æ¶æ„éœ€è¦åšå‡ºçš„ä¼ä¸šæ–‡åŒ–ã€ç»„ç»‡æ¶æ„å’ŒæŠ€æœ¯å˜é©ï¼Œå¹¶ç»™å‡ºäº†è¿ç§»æŒ‡å—ã€‚

ä¸»è¦è®¨è®ºçš„åº”ç”¨ç¨‹åºæ¶æ„åŒ…æ‹¬ï¼š

* åäºŒå› ç´ åº”ç”¨ç¨‹åºï¼šäº‘åŸç”Ÿåº”ç”¨ç¨‹åºæ¶æ„æ¨¡å¼çš„é›†åˆ
* å¾®æœåŠ¡ï¼šç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡ï¼Œåªåšä¸€ä»¶äº‹æƒ…
* è‡ªåŠ©æœåŠ¡çš„æ•æ·åŸºç¡€è®¾æ–½ï¼šå¿«é€Ÿï¼Œå¯é‡å¤å’Œä¸€è‡´åœ°æä¾›åº”ç”¨ç¯å¢ƒå’Œåå°æœåŠ¡çš„å¹³å°
* åŸºäºAPIçš„åä½œï¼šå‘å¸ƒå’Œç‰ˆæœ¬åŒ–çš„APIï¼Œå…è®¸åœ¨äº‘åŸç”Ÿåº”ç”¨ç¨‹åºæ¶æ„ä¸­çš„æœåŠ¡ä¹‹é—´è¿›è¡Œäº¤äº’
* æŠ—å‹æ€§ï¼šæ ¹æ®å‹åŠ›å˜å¼ºçš„ç³»ç»Ÿ

è¯¦è§ï¼š[è¿ç§»åˆ°äº‘åŸç”Ÿåº”ç”¨æ¶æ„](https://jimmysong.io/migrating-to-cloud-native-application-architectures/)

### è¿ç§»æ¡ˆä¾‹è§£æ

è¿ç§»æ­¥éª¤ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![è¿ç§»æ­¥éª¤ç¤ºæ„å›¾](../images/migrating-hadoop-yarn-to-kubernetes.png)

æ­¥éª¤è¯´æ˜ï¼š

1. å°†åŸæœ‰åº”ç”¨æ‹†è§£ä¸ºæœåŠ¡
2.  å®šä¹‰æœåŠ¡çš„æ¥å£/APIé€šä¿¡æ–¹å¼
3.  ç¼–å†™å¯åŠ¨è„šæœ¬ä½œä¸ºå®¹å™¨çš„è¿›ç¨‹å…¥å£
4.  å‡†å¤‡åº”ç”¨é…ç½®æ–‡ä»¶
5.  å®¹å™¨åŒ–ã€åˆ¶ä½œé•œåƒ
6.  å‡†å¤‡Kubernetes YAMLæ–‡ä»¶
7.  å¦‚æœæœ‰å¤–ç½®é…ç½®æ–‡ä»¶éœ€è¦åˆ›å»ºConfigMapæˆ–Secretå­˜å‚¨

è¯¦è§ï¼š[è¿ç§»ä¼ ç»Ÿåº”ç”¨åˆ°Kubernetesæ­¥éª¤è¯¦è§£â€”â€”ä»¥Hadoop YARNä¸ºä¾‹](https://jimmysong.io/posts/migrating-hadoop-yarn-to-kubernetes/)ã€‚

## Service MeshåŸºæœ¬åŸç†å’Œç¤ºä¾‹ä»‹ç»

Service Meshç°åœ¨ä¸€èˆ¬è¢«ç¿»è¯‘ä½œæœåŠ¡ç½‘æ ¼ï¼Œç›®å‰ä¸»æµçš„Service Meshæœ‰å¦‚ä¸‹å‡ æ¬¾ï¼š

* [Istio](https://istio.io)ï¼šIBMã€Googleã€Lyftå…±åŒå¼€æºï¼Œè¯¦ç»†æ–‡æ¡£è§[Istioå®˜æ–¹ä¸­æ–‡æ–‡æ¡£](https://istio.io/zh/)
* [Linkerd](https://linkerd.io)ï¼šåŸTwitterå·¥ç¨‹å¸ˆå¼€å‘ï¼Œç°ä¸º[CNCF](https://cncf.io)ä¸­çš„é¡¹ç›®ä¹‹ä¸€
* [Envoy](https://www.envoyproxy.io/)ï¼šLyftå¼€æºçš„ï¼Œå¯ä»¥åœ¨Istioä¸­ä½¿ç”¨Sidecaræ¨¡å¼è¿è¡Œ
* [Conduit](https://conduit.io)ï¼šåŒæ ·ç”±Buoyantå¼€æºçš„è½»é‡çº§çš„åŸºäºKubernetesçš„Service Mesh

æ­¤å¤–è¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„Service Meshé±¼è´¯è€Œå‡ºï¼Œè¯·å‚è€ƒ[awesome-cloud-native](https://jimmysong.io/awesome-cloud-native)ã€‚

### ä»€ä¹ˆæ˜¯Service Mesh

å¦‚æœç”¨ä¸€å¥è¯æ¥è§£é‡Šä»€ä¹ˆæ˜¯ Service Meshï¼Œå¯ä»¥å°†å®ƒæ¯”ä½œæ˜¯åº”ç”¨ç¨‹åºæˆ–è€…è¯´å¾®æœåŠ¡é—´çš„ TCP/IPï¼Œè´Ÿè´£æœåŠ¡ä¹‹é—´çš„ç½‘ç»œè°ƒç”¨ã€é™æµã€ç†”æ–­å’Œç›‘æ§ã€‚å¯¹äºç¼–å†™åº”ç”¨ç¨‹åºæ¥è¯´ä¸€èˆ¬æ— é¡»å…³å¿ƒ TCP/IP è¿™ä¸€å±‚ï¼ˆæ¯”å¦‚é€šè¿‡ HTTP åè®®çš„ RESTful åº”ç”¨ï¼‰ï¼ŒåŒæ ·ä½¿ç”¨ Service Mesh ä¹Ÿå°±æ— é¡»å…³å¿ƒæœåŠ¡ä¹‹é—´çš„é‚£äº›åŸæ¥æ˜¯é€šè¿‡åº”ç”¨ç¨‹åºæˆ–è€…å…¶ä»–æ¡†æ¶å®ç°çš„äº‹æƒ…ï¼Œæ¯”å¦‚ Spring Cloudã€OSSï¼Œç°åœ¨åªè¦äº¤ç»™ Service Mesh å°±å¯ä»¥äº†ã€‚

![service meshæ¶æ„å›¾](../images/serivce-mesh-control-plane.png)

è¯¦è§[ä»€ä¹ˆæ˜¯ Service Mesh - jimmysong.io](https://jimmysong.io/posts/what-is-a-service-mesh/)ã€‚

### Service Meshä½¿ç”¨æŒ‡å—

ä¸¤æ¬¾Service Meshå„æœ‰åƒç§‹ï¼Œæˆ‘åˆ†åˆ«å†™äº†ä»–ä»¬çš„ä½¿ç”¨æ¡ˆä¾‹æŒ‡å—ï¼š

* [å¾®æœåŠ¡ç®¡ç†æ¡†æ¶Service Meshâ€”â€”Linkerdå®‰è£…è¯•ç”¨ç¬”è®°](https://jimmysong.io/posts/linkerd-user-guide/)
* [å¾®æœåŠ¡ç®¡ç†æ¡†æ¶Service Meshâ€”â€”Istioå®‰è£…è¯•ç”¨ç¬”è®°](https://jimmysong.io/posts/istio-installation/)

æ›´å¤šå…³äº Service Mesh çš„å†…å®¹è¯·è®¿é—® [ServiceMesher ç¤¾åŒºç½‘ç«™](http://www.servicemesher.com)ã€‚

## ä½¿ç”¨æ¡ˆä¾‹

Kubernetesä½œä¸ºäº‘åŸç”Ÿè®¡ç®—çš„åŸºæœ¬ç»„ä»¶ä¹‹ä¸€ï¼Œå¼€æº2å¹´æ—¶é—´ä»¥æ¥çƒ­åº¦ä¸æ—¥ä¿±å¢ï¼Œå®ƒå¯ä»¥è·Ÿæˆ‘ä»¬çš„ç”Ÿäº§ç»“åˆï¼Œæ“¦å‡ºå¾ˆå¤šç«èŠ±ï¼Œæ¯”å¦‚FaaSå’ŒServerlessç±»åº”ç”¨ï¼Œéƒ½å¾ˆé€‚åˆè¿è¡Œåœ¨kubernetesä¸Šã€‚

å…³äºCloud Nativeå¼€æºè½¯ä»¶ç”Ÿæ€è¯·å‚è€ƒ [Awesome Cloud Native - jimmysong.io](https://jimmysong.io/awesome-cloud-native)ã€‚

### DevOps

ä¸‹é¢æ˜¯ç¤¾åŒºä¸­Kuberneteså¼€æºçˆ±å¥½è€…çš„åˆ†äº«å†…å®¹ï¼Œæˆ‘è§‰å¾—æ˜¯å¯¹Kubernetesåœ¨DevOpsä¸­åº”ç”¨çš„å¾ˆå¥½çš„å½¢å¼å€¼å¾—å¤§å®¶å€Ÿé‰´ã€‚

çœŸæ­£è·µè¡ŒDevOpsï¼Œè®©å¼€å‘äººå‘˜åœ¨æŒæ¡è‡ªå·±çš„å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒï¼Œè®©ç¯å¢ƒä¸€è‡´ï¼Œè®©å¼€å‘æ•ˆç‡æå‡ï¼Œè®©è¿ç»´æ²¡æœ‰å †ç§¯å¦‚å±±çš„ticketsï¼Œè®©ç›‘æ§æ›´åŠ ç²¾å‡†ï¼Œä»Kuberneteså¹³å°å¼€å§‹ã€‚

**è¡ŒåŠ¨æŒ‡å—**

1. æ ¹æ®ç¯å¢ƒï¼ˆæ¯”å¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰åˆ’åˆ†`namespace`ï¼Œä¹Ÿå¯ä»¥æ ¹æ®é¡¹ç›®æ¥åˆ’åˆ†
2. å†ä¸ºæ¯ä¸ªç”¨æˆ·åˆ’åˆ†ä¸€ä¸ª`namespace`ã€åˆ›å»ºä¸€ä¸ª`serviceaccount`å’Œ`kubeconfig`æ–‡ä»¶ï¼Œä¸åŒ`namespace`é—´çš„èµ„æºéš”ç¦»ï¼Œç›®å‰ä¸éš”ç¦»ç½‘ç»œï¼Œä¸åŒ`namespace`é—´çš„æœåŠ¡å¯ä»¥äº’ç›¸è®¿é—®
3. åˆ›å»ºyamlæ¨¡æ¿ï¼Œé™ä½ç¼–å†™Kubernetes yamlæ–‡ä»¶ç¼–å†™éš¾åº¦
4. åœ¨`kubectl`å‘½ä»¤ä¸Šå†å°è£…ä¸€å±‚ï¼Œå¢åŠ ç”¨æˆ·èº«ä»½è®¾ç½®å’Œç¯å¢ƒåˆå§‹åŒ–æ“ä½œï¼Œç®€åŒ–`kubectl`å‘½ä»¤å’Œå¸¸ç”¨åŠŸèƒ½
5. ç®¡ç†å‘˜é€šè¿‡dashboardæŸ¥çœ‹ä¸åŒ`namespace`çš„çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒæ¥ä½¿æ“ä½œæ›´ä¾¿æ·
6. æ‰€æœ‰åº”ç”¨çš„æ—¥å¿—ç»Ÿä¸€æ”¶é›†åˆ°ElasticSearchä¸­ï¼Œç»Ÿä¸€æ—¥å¿—è®¿é—®å…¥å£
7. å¯ä»¥é€šè¿‡GrafanaæŸ¥çœ‹æ‰€æœ‰namespaceä¸­çš„åº”ç”¨çš„çŠ¶æ€å’Œkubernetesé›†ç¾¤æœ¬èº«çš„çŠ¶æ€
8. éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ä¿å­˜åœ¨åˆ†å¸ƒå¼å­˜å‚¨ä¸­ï¼Œä¾‹å¦‚GlusterFSæˆ–Cephä¸­

**ä½¿ç”¨KibanaæŸ¥çœ‹æ—¥å¿—**

æ—¥å¿—å­—æ®µä¸­åŒ…æ‹¬äº†åº”ç”¨çš„æ ‡ç­¾ã€å®¹å™¨åç§°ã€ä¸»æœºåç§°ã€å®¿ä¸»æœºåç§°ã€IPåœ°å€ã€æ—¶é—´ã€

![kibanaç•Œé¢](../images/filebeat-docker-test.jpg)

**ä½¿ç”¨GrafanaæŸ¥çœ‹åº”ç”¨çŠ¶æ€**

**æ³¨**ï¼šæ„Ÿè°¢ã€K8SğŸ¤˜Cloud Nativeå®æˆ˜ç¾¤ã€‘å°Šè´µçš„é»„é‡‘ä¼šå‘˜å°åˆšåŒå­¦æä¾›ä¸‹é¢çš„Grafanaç›‘æ§å›¾ğŸ™

ç›‘æ§åˆ†ç±»ç¤ºæ„å›¾ï¼š

![Grafanaç•Œé¢ç¤ºæ„å›¾1](../images/kubernetes-devops-example-grafana-1.png)

Kubernetesé›†ç¾¤å…¨å±€ç›‘æ§å›¾1

è¯¥ç›‘æ§å›¾å¯ä»¥çœ‹åˆ°é›†ç¾¤ç¡¬ä»¶ä½¿ç”¨æƒ…å†µã€‚

![Grafanaç•Œé¢ç¤ºæ„å›¾2](../images/kubernetes-devops-example-grafana-2.png)

Kuberneteså…¨å±€ç›‘æ§å›¾2

è¯¥ç›‘æ§å¯ä»¥çœ‹åˆ°å•ä¸ªç”¨æˆ·çš„namespaceä¸‹çš„æ‰€æœ‰èµ„æºçš„ä½¿ç”¨æƒ…å†µã€‚

![Grafanaç•Œé¢ç¤ºæ„å›¾3](../images/kubernetes-devops-example-grafana-3.png)

### Spark on Kubernetes

TL;DR [https://jimmysong.io/spark-on-k8s](https://jimmysong.io/spark-on-k8s)

SparkåŸç”Ÿæ”¯æŒstandaloneã€mesoså’ŒYARNèµ„æºè°ƒåº¦ï¼Œç°å·²æ”¯æŒKubernetesåŸç”Ÿè°ƒåº¦ï¼Œè¯¦è§[è¿è¡Œæ”¯æŒKubernetesåŸç”Ÿè°ƒåº¦çš„sparkç¨‹åº-Spark on Kubernetes](https://jimmysong.io/posts/running-spark-with-kubernetes-native-scheduler/)ã€‚

**ä¸ºä½•è¦ä½¿ç”¨spark on kubernetes**

ä½¿ç”¨KubernetesåŸç”Ÿè°ƒåº¦çš„spark on kubernetesæ˜¯å¯¹åŸå…ˆçš„spark on yarnå’Œyarn on dockerçš„æ”¹å˜æ˜¯é©å‘½æ€§çš„ï¼Œä¸»è¦è¡¨ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **KubernetesåŸç”Ÿè°ƒåº¦**ï¼šä¸å†éœ€è¦äºŒå±‚è°ƒåº¦ï¼Œç›´æ¥ä½¿ç”¨Kubernetesçš„èµ„æºè°ƒåº¦åŠŸèƒ½ï¼Œè·Ÿå…¶ä»–åº”ç”¨å…±ç”¨æ•´ä¸ªkubernetesç®¡ç†çš„èµ„æºæ± ï¼›
2. **èµ„æºéš”ç¦»ï¼Œç²’åº¦æ›´ç»†**ï¼šåŸå…ˆyarnä¸­çš„queueåœ¨spark on kubernetesä¸­å·²ä¸å­˜åœ¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯kubernetesä¸­åŸç”Ÿçš„namespaceï¼Œå¯ä»¥ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†åˆ«æŒ‡å®šä¸€ä¸ªnamespaceï¼Œé™åˆ¶ç”¨æˆ·çš„èµ„æºquotaï¼›
3. **ç»†ç²’åº¦çš„èµ„æºåˆ†é…**ï¼šå¯ä»¥ç»™æ¯ä¸ªsparkä»»åŠ¡æŒ‡å®šèµ„æºé™åˆ¶ï¼Œå®é™…æŒ‡å®šå¤šå°‘èµ„æºå°±ä½¿ç”¨å¤šå°‘èµ„æºï¼Œå› ä¸ºæ²¡æœ‰äº†åƒyarné‚£æ ·çš„äºŒå±‚è°ƒåº¦ï¼ˆåœˆåœ°å¼çš„ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥æ›´é«˜æ•ˆå’Œç»†ç²’åº¦çš„ä½¿ç”¨èµ„æºï¼›
4. **ç›‘æ§çš„å˜é©**ï¼šå› ä¸ºåšåˆ°äº†ç»†ç²’åº¦çš„èµ„æºåˆ†é…ï¼Œæ‰€ä»¥å¯ä»¥å¯¹ç”¨æˆ·æäº¤çš„æ¯ä¸€ä¸ªä»»åŠ¡åšåˆ°èµ„æºä½¿ç”¨çš„ç›‘æ§ï¼Œä»è€Œåˆ¤æ–­ç”¨æˆ·çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œæ‰€æœ‰çš„metricéƒ½è®°å½•åœ¨æ•°æ®åº“ä¸­ï¼Œç”šè‡³å¯ä»¥ä¸ºæ¯ä¸ªç”¨æˆ·çš„æ¯æ¬¡ä»»åŠ¡æäº¤è®¡é‡ï¼›
5. **æ—¥å¿—çš„å˜é©**ï¼šç”¨æˆ·ä¸å†é€šè¿‡yarnçš„webé¡µé¢æ¥æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ï¼Œè€Œæ˜¯é€šè¿‡podçš„logæ¥æŸ¥çœ‹ï¼Œå¯å°†æ‰€æœ‰çš„kuberentesä¸­çš„åº”ç”¨çš„æ—¥å¿—ç­‰åŒçœ‹å¾…æ”¶é›†èµ·æ¥ï¼Œç„¶åå¯ä»¥æ ¹æ®æ ‡ç­¾æŸ¥çœ‹å¯¹åº”åº”ç”¨çš„æ—¥å¿—ï¼›

**å¦‚ä½•æäº¤ä»»åŠ¡**

ä»ç„¶ä½¿ç”¨`spark-submit`æäº¤sparkä»»åŠ¡ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šKubernetes API serveråœ°å€ï¼Œä¸‹é¢çš„å‘½ä»¤æäº¤æœ¬åœ°jaråŒ…åˆ°Kubernetesé›†ç¾¤ä¸Šè¿è¡Œï¼ŒåŒæ—¶æŒ‡å®šäº†è¿è¡Œä»»åŠ¡çš„ç”¨æˆ·ã€æäº¤å‘½åçš„ç”¨æˆ·ã€è¿è¡Œçš„excutorå®ä¾‹æ•°ã€driverå’Œexecutorçš„èµ„æºé™åˆ¶ã€ä½¿ç”¨çš„sparkç‰ˆæœ¬ç­‰ä¿¡æ¯ã€‚

è¯¦ç»†ä½¿ç”¨è¯´æ˜è§[Apache Spark on Kubernetesç”¨æˆ·æŒ‡å— - jimmysong.io](https://jimmysong.io/spark-on-k8s/user-guide.html)ã€‚

```bash
./spark-submit \
  --deploy-mode cluster \
  --class com.talkingdata.alluxio.hadooptest \
  --master k8s://https://172.20.0.113:6443 \
  --kubernetes-namespace spark-cluster \
  --conf spark.kubernetes.driverEnv.SPARK_USER=hadoop \
  --conf spark.kubernetes.driverEnv.HADOOP_USER_NAME=hadoop \
  --conf spark.executorEnv.HADOOP_USER_NAME=hadoop \
  --conf spark.executorEnv.SPARK_USER=hadoop \
  --conf spark.kubernetes.authenticate.driver.serviceAccountName=spark \
  --conf spark.driver.memory=100G \
  --conf spark.executor.memory=10G \
  --conf spark.driver.cores=30 \
  --conf spark.executor.cores=2 \
  --conf spark.driver.maxResultSize=10240m \
  --conf spark.kubernetes.driver.limit.cores=32 \
  --conf spark.kubernetes.executor.limit.cores=3 \
  --conf spark.kubernetes.executor.memoryOverhead=2g \
  --conf spark.executor.instances=5 \
  --conf spark.app.name=spark-pi \
  --conf spark.kubernetes.driver.docker.image=harbor-001.jimmysong.io/library/spark-driver:v2.1.0-kubernetes-0.3.1-1 \
  --conf spark.kubernetes.executor.docker.image=harbor-001.jimmysong.io/library/spark-executor:v2.1.0-kubernetes-0.3.1-1 \
  --conf spark.kubernetes.initcontainer.docker.image=harbor-001.jimmysong.io/library/spark-init:v2.1.0-kubernetes-0.3.1-1 \
  --conf spark.kubernetes.resourceStagingServer.uri=http://172.20.0.114:31000 \
~/Downloads/tendcloud_2.10-1.0.jar
```

**ç›‘æ§**

ä¸‹å›¾æ˜¯ä»Kubernetes dashboardä¸Šçœ‹åˆ°çš„spark-clusterè¿™ä¸ªnamespaceä¸Šè¿è¡Œçš„åº”ç”¨æƒ…å†µã€‚

![dashboard](../images/spark-job-on-kubernetes-example-1.jpg)

ä¸‹å›¾æ˜¯ä»Grafanaç›‘æ§é¡µé¢ä¸ŠæŸ¥çœ‹åˆ°çš„æŸä¸ªexecutorèµ„æºå ç”¨æƒ…å†µã€‚

![Grafana](../images/spark-job-on-kubernetes-example-2.jpg)

## å‚è€ƒ

* [è¿ç§»åˆ°äº‘åŸç”Ÿåº”ç”¨æ¶æ„æŒ‡å—](https://jimmysong.io/migrating-to-cloud-native-application-architectures)
* [Cloud Native Go - å·²ç”±ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾å‡ºç‰ˆ](https://jimmysong.io/cloud-native-go)
* [Cloud Native Python - å·²ç”±ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾å‡ºç‰ˆ](https://jimmysong.io/posts/cloud-native-python)
* [Istio Service Mesh ä¸­æ–‡æ–‡æ¡£](https://istio.io/zh/)
