---
title: "ã€ŠService Mesh å®æˆ˜â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®è·µã€‹è¯»åæ„Ÿ"
date: 2019-01-08T20:50:44+08:00
bigimg: [{src: "https://ws3.sinaimg.cn/large/006tNc79ly1fyzh65bll4j31h60qunb2.jpg", desc: "Photo via unsplash"}]
draft: false
notoc: true
description: "ã€ŠService Mesh å®æˆ˜â€”â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®æˆ˜ã€‹çš„è§‚åæ„Ÿï¼Œé¡ºä¾¿å¯¹æ¯”äº†ä¸‹ Linkerd å’Œ Envoyï¼Œç»™è¯»è€…ä¸€äº›æˆ‘è‡ªå·±çš„å»ºè®®ã€‚"
tags: ["book","linkerd","service mesh"]
categories: ["service mesh"]
---

æœ€è¿‘åœ¨å›é¡¾ Service Mesh æŠ€æœ¯åœ¨2018å¹´çš„å‘å±•ï¼Œæƒ³å†çœ‹çœ‹ Linkerdï¼Œæ­£å¥½**æ¨å½°æ˜¾**çš„è¿™æœ¬ã€ŠService Mesh å®æˆ˜â€”â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®è·µã€‹ä¸Šå¸‚å‘å”®äº†ï¼Œ**æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾**çš„ç¼–è¾‘é€äº†æˆ‘ä¸€æœ¬ï¼ŒğŸ™**æ¨ç¦å·**ç¼–è¾‘ï¼Œæˆ‘çœ‹äº†ä¸‹æŠ½ç©ºå†™äº†ç‚¹è¯»åæ„Ÿï¼Œæˆ‘çœ‹äº†ä¸‹æŠ½ç©ºå†™äº†ç‚¹è¯»åæ„Ÿï¼Œå…¶å®ä¹Ÿè¯´ä¸ä¸Šæ˜¯è¯»åæ„Ÿï¼Œå°±å½“æ˜¯è‡ªå·±çš„ä¸€ç‚¹æ„Ÿæ‚Ÿå§ï¼Œå°±å½“æ‹¿æ­¤ä¹¦å€Ÿé¢˜å‘æŒ¥å§ï¼Œè¿™ä¸ªçŸ¥è¯†çˆ†ç‚¸çš„å¹´ä»£ï¼ŒæŠ€æœ¯å‘å±•å¦‚æ­¤è¿…é€Ÿï¼Œå¯ä»¥è¯´æ˜¯ IT äººå‘˜çš„å¹¸è¿ï¼Œä¹Ÿæ˜¯ä¸å¹¸ï¼æœ‰å¤šå°‘å†™å¼€æºè½¯ä»¶çš„ä¹¦æ¨å‡ºä¸€ç‰ˆåèƒ½æ’‘è¿‡ä¸‰å¹´çš„ï¼Ÿå¦‚æœè½¯ä»¶çº¢å¾—å‘ç´«ï¼ŒæŒç»­è¿­ä»£ N ä¸ªç‰ˆæœ¬ï¼Œä¾‹å¦‚ Kubernetesï¼Œæœ€è¿‘ä¸¤å¹´ä»¥æ¯ä¸‰ä¸ªæœˆä¸€ä¸ªç‰ˆæœ¬çš„é€Ÿåº¦è¿­ä»£ï¼Œä¹‹å‰çš„ä¹¦æ—©å°±è·Ÿä¸ä¸ŠèŠ‚å¥ï¼Œè¦ä¹ˆå°±è¦ä¸æ–­æ¨å‡ºæ–°ç‰ˆï¼Œç›´åˆ°è½¯ä»¶ç¨³å®šåä¸å†æœ‰å¤§çš„æ”¹åŠ¨ã€‚è¿˜æœ‰ç§å¯èƒ½å°±æ˜¯è½¯ä»¶æ¨å¹¿å’Œå‘å±•çš„ä¸ç†æƒ³ï¼Œæ— äººé—®æ´¥ï¼Œå†™è¿™æ ·è½¯ä»¶çš„ä¹¦å°±ä¸ä¼šæœ‰å†ç‰ˆäº†ã€‚

![Service Mesh å®æˆ˜â€”â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®è·µ](https://ws1.sinaimg.cn/large/006tNc79ly1fyzgoqr5odj30u013px6p.jpg)

æ‹¿åˆ°æœ¬ä¹¦åæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯çœ‹çœ‹è¿™æœ¬ä¹¦å®šç¨¿çš„æ—¶å€™ Istio æ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼ŒLinkerd åˆæ˜¯ä»€ä¹ˆç‰ˆæœ¬ã€‚å› ä¸ºåœ¨è¿™ä¸€å¹´å†…ä¸¤æ¬¾å¼€æºè½¯ä»¶éƒ½æœ‰è¾ƒå¤§çš„ç‰ˆæœ¬å˜åŠ¨ï¼Œå¦‚æœä¹¦ç±å®šç¨¿çš„æ—¶å€™åŸºäºçš„è½¯ä»¶ç‰ˆæœ¬å¤ªä½ï¼Œè½¯ä»¶æ¶æ„å¯èƒ½ä¼šæœ‰è¾ƒå¤§çš„å˜åŒ–ï¼Œå½±å“ä¹¦ä¸­ç¤ºä¾‹å’Œéƒ¨åˆ†ç« èŠ‚çš„æ—¶æ•ˆæ€§ã€‚è¿™ä¹Ÿæ˜¯å¤§å¤šæŠ€æœ¯ä¹¦ç±åçŸ­çš„ç—‡ç»“æ‰€åœ¨ï¼ŒæŠ€æœ¯å‘å±•æ˜¯åœ¨å¤ªå¿«ï¼Œä¼ ç»Ÿçš„ä¹¦ç±å‡ºç‰ˆæµç¨‹å¾€å¾€è¿‡äºç¹çå’Œå†—é•¿ï¼Œç­‰åˆ°ä¹¦ç±å‡ºç‰ˆåæ‰€ä»‹ç»çš„è½¯ä»¶éƒ½å‡ºäº†å¥½å‡ ä¸ªç‰ˆæœ¬ã€‚ä¾‹å¦‚ Kubernetes è¿™ç§çš„è½¯ä»¶ï¼Œæ¯ä¸‰ä¸ªæœˆä¸€ä¸ªç‰ˆæœ¬ï¼Œè€Œå†™ä¸€èˆ¬ä¹¦ä»ç­–åˆ’åˆ°å‘è¡Œå°‘è¯´åŠå¹´ï¼Œä¸€èˆ¬ä¹Ÿè¦ä¸€å¹´çš„æ—¶é—´ã€‚

## å…³äºä¹¦ç±å®šç¨¿æ—¶çš„è½¯ä»¶ç‰ˆæœ¬

**Istio 0.8**

æœ¬ä¹¦ç¬¬ä¸€ç« ã€ŒService Mesh ç®€ä»‹ã€å¯¹ Service Mesh ç›¸å…³å¼€æºäº§å“ä»‹ç»æ—¶æåˆ°æœ¬ä¹¦å®šç¨¿æ—¶ Istio æ˜¯ 0.8 ç‰ˆæœ¬ï¼Œè€Œ Istio åœ¨ 2018å¹´7æœˆ31æ—¥å‘å¸ƒäº† [1.0 ç‰ˆæœ¬](https://istio.io/zh/about/notes/1.0/)ã€‚

![Service Mesh å®æˆ˜ï¼ŒåŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®æˆ˜](https://ws2.sinaimg.cn/large/006tNc79ly1fyya5b4xzpj318z0u0e81.jpg)

è¿™æœ¬ä¹¦å®šç¨¿æ—¶ï¼ŒIstio çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.8ã€‚

**Linkerd 1.3.6**

æœ¬ä¹¦ä»åºè¨€å¼€å§‹ä¸€ç›´åˆ°ç¬¬äºŒç« ç»“æŸä¹Ÿæ²¡æœ‰æåŠå†™ä½œæ—¶åŸºäºçš„ Linkerd ç‰ˆæœ¬ï¼Œæˆ‘åœ¨ç¬¬äºŒç« çš„å®‰è£…æ­¥éª¤ä¸­çœ‹åˆ°äº†è¯´æ˜ã€‚

![Service Mesh å®æˆ˜ï¼ŒåŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®æˆ˜](https://ws1.sinaimg.cn/large/006tNc79ly1fyyacp4t1nj318z0u0b29.jpg)

å¯ä»¥çœ‹åˆ°æœ¬ä¹¦å†™ä½œæ—¶æ˜¯åŸºäº Linkerd 1.3.6 ç‰ˆæœ¬ï¼Œè€Œ Linkerd åœ¨åŒå¹´çš„ 9æœˆ18æ—¥å‘å¸ƒäº† [2.0 GA](http://www.servicemesher.com/blog/linkerd-2-0-in-general-availability/)ï¼Œè¿™ä¸€ç‰ˆæœ¬è·Ÿ 1.x ç‰ˆæœ¬ç›¸æ¯”æœ‰é‡å¤§å˜åŒ–â€”â€”å®ƒè¿˜å°†é¡¹ç›®ä»é›†ç¾¤èŒƒå›´çš„service meshè½¬æ¢ä¸ºå¯ç»„åˆçš„ *service sidecar* ï¼Œæ—¨åœ¨ä¸ºå¼€å‘äººå‘˜å’ŒæœåŠ¡æ‰€æœ‰è€…æä¾›åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­æˆåŠŸæ‰€éœ€çš„å…³é”®å·¥å…·ã€‚

## Linkerd vs Envoy

Linkerd 2.0 çš„ service sidecar è®¾è®¡ä½¿å¼€å‘äººå‘˜å’ŒæœåŠ¡æ‰€æœ‰è€…èƒ½å¤Ÿåœ¨ä»–ä»¬çš„æœåŠ¡ä¸Šè¿è¡Œ Linkerdï¼Œæä¾›è‡ªåŠ¨å¯è§‚å¯Ÿæ€§ã€å¯é æ€§å’Œè¿è¡Œæ—¶è¯Šæ–­ï¼Œè€Œæ— éœ€æ›´æ”¹é…ç½®æˆ–ä»£ç ã€‚é€šè¿‡æä¾›è½»é‡çº§çš„å¢é‡è·¯å¾„æ¥è·å¾—å¹³å°èŒƒå›´çš„é¥æµ‹ã€å®‰å…¨æ€§å’Œå¯é æ€§çš„ä¼ ç»Ÿ service mesh åŠŸèƒ½ï¼Œservice sidecar æ–¹æ³•è¿˜é™ä½äº†å¹³å°æ‰€æœ‰è€…å’Œç³»ç»Ÿæ¶æ„å¸ˆçš„é£é™©ã€‚è¯¥ç‰ˆæœ¬è¿˜ç”¨ Rust é‡å†™äº†ä»£ç†éƒ¨åˆ†ï¼Œåœ¨å»¶è¿Ÿï¼Œååé‡å’Œèµ„æºæ¶ˆè€—æ–¹é¢äº§ç”Ÿäº†æ•°é‡çº§çš„æ”¹è¿›ã€‚

è€Œ Linkerd 1.x ç»§æ‰¿è‡ª Twitter å¼€æºçš„ Finagle é«˜æ€§èƒ½ RPCï¼Œæ‰€æœ‰æƒ³è¦æ·±åº¦å­¦ä¹  Linkerd 1.x è¿˜éœ€è¦äº†è§£ Finagleï¼Œè¿™å°±è·Ÿ Istio å°† Envoy ä½œä¸ºé»˜è®¤çš„æ•°æ®å¹³é¢ä¸€æ ·ï¼Œè¦æƒ³æ·±åº¦å­¦ä¹  Istio å¿…é¡»äº†è§£ Envoyã€‚

ä¹¦ä¸­é™„èµ äº†ä¸€å¹… Linkerd é…ç½®å›¾ã€‚

![Linkerd é…ç½®](https://ws1.sinaimg.cn/large/006tNc79ly1fyzd9gh23nj30g00th78p.jpg)

*åŸå›¾è§ï¼šhttps://github.com/yangzhares/linkerd-in-action/blob/master/linkerd.png*

å¯è§è¿™åˆæ˜¯è·Ÿ Envoy å®Œå…¨ä¸ä¸€æ ·çš„æ•°æ®ç»“æ„ï¼ŒEnvoy çš„é…ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![Envoy é…ç½®åˆ†ç±»](https://ws3.sinaimg.cn/large/006tNbRwly1fyb74brsd5j30xg0lojvt.jpg)

è¯¦æƒ…è¯·å‚è€ƒ [Envoy é…ç½®è¯¦è§£](https://jimmysong.io/istio-handbook/data-plane/envoy-proxy-config-deep-dive.html)ã€‚

ä»ä¸Šé¢ä¸¤å¼ å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒäºŒè€…å‡ ä¹ä½¿ç”¨äº†å®Œå…¨ä¸åŒçš„æœ¯è¯­ï¼Œå‡å¦‚ä½ å·²ç»äº†è§£äº† [Envoy](http://www.servicemesher.com/envoy/) æƒ³è¦å†åˆ‡æ¢åˆ° Linkerd ä¸Šï¼Œé‚£ä¹ˆå°±è¦å†è´¹å¾ˆå¤šå¿ƒåŠ›æ¥å­¦ä¹ å®ƒçš„æ¦‚å¿µå’ŒåŸç†ï¼Œä¾‹å¦‚å¦‚ä¸‹è¿™äº›æœ¯è¯­æˆ–é…ç½®ï¼ˆLinkerd ä¸­ç‹¬æœ‰çš„é…ç½®ï¼‰ï¼š

- **dtabï¼ˆå§”æ‰˜è¡¨ï¼‰**ï¼šç”±ä¸€ç³»åˆ—è·¯ç”±ç»„æˆï¼Œç”±ä¸€ç³»åˆ—è·¯ç”±è§„åˆ™ç»„æˆï¼Œä»¥é€»è¾‘è·¯å¾„ä¸ºè¾“å…¥ï¼Œç„¶åç»è¿‡è·¯ç”±è§„åˆ™åšä¸€ç³»åˆ—è½¬æ¢ç”Ÿæˆå…·ä½“åå­—ã€‚è¿™æ˜¯ Linkerd è·¯ç”±æœºåˆ¶çš„æ ¹æœ¬ï¼Œå°±åƒ Envoy ä¸­çš„ [xDS åè®®](https://jimmysong.io/istio-handbook/data-plane/envoy-xds.html)ä¸€æ ·ï¼Œæœ¬ä¹¦çš„ç¬¬å››ç« ã€Œæ·±å…¥ Linkerd æ•°æ®è®¿é—®æµã€ä¸“é—¨è®²è§£äº† dtab çš„å®ç°æœºåˆ¶ã€‚
- **dentryï¼ˆå§”æ‰˜è¡¨è®°å½•ï¼‰**ï¼šå§”æ‰˜è¡¨çš„æ¯æ¡è·¯ç”±è§„åˆ™ç§°ä¸º dentryï¼Œå¦‚ /consul => /#/io.l5d.consul/dc1ã€‚
- **namer**ï¼šé…ç½® Linkerd æ”¯æŒçš„æœåŠ¡å‘ç°å·¥å…·ã€‚
- **namerd**ï¼šLinkerd çš„æ§åˆ¶å¹³é¢ï¼Œç›¸å½“äº Istio ä¸­çš„ Pilotï¼Œå¯¹æ¥å„ç§æœåŠ¡å‘ç°ã€‚å½“ç„¶ Linkerd ä¹Ÿå¯ä»¥ç›´æ¥ä¸æŸä¸ªæœåŠ¡å‘ç°å¹³å°å¯¹æ¥å¦‚ consulï¼Œè€Œä¸ä½¿ç”¨ namerd è¿™ä¸ªé›†ä¸­è·¯ç”±å’Œé…ç½®ç®¡ç†ç»„ä»¶ã€‚
- **interpreter**ï¼šinterpreter å†³å®šå¦‚ä½•è§£ææœåŠ¡åå­—å’Œå®¢æˆ·ç«¯åå­—ã€‚

è™½ç„¶ Linkerd ä¹Ÿæ˜¯ [CNCF ä¸­çš„é¡¹ç›®](https://www.cncf.io/projects/)ï¼Œä½†å®ƒç›®å‰è¿˜å¤„äºå­µåŒ–é˜¶æ®µï¼Œè€Œ Envoy çš„ [xDS åè®®](https://jimmysong.io/istio-handbook/data-plane/envoy-xds.html)å·²ç»è¢«ä¼—å¤šå¼€æºé¡¹ç›®æ‰€æ”¯æŒï¼Œå¦‚ [Istio](https://istio.io/zh)ã€[SOFAMesh](https://github.com/alipay/sofa-mesh)ã€[NginxMesh](https://github.com/nginxinc/nginmesh) ç­‰ï¼Œä¸” Envoy å·²ç»ä» CNCF ä¸­æ¯•ä¸šï¼Œä»¥åå¯èƒ½æˆä¸º Service Mesh é¢†åŸŸçš„æ ‡å‡†åè®®ï¼ŒLinkerd çš„ç”Ÿå­˜çŠ¶å†µå ªå¿§ã€‚

## å…³äºæœ¬ä¹¦

æœ¬ä¹¦ä¸­æ‰€æœ‰ç¤ºä¾‹éƒ½æä¾›äº†è™šæ‹Ÿæœºçš„å¿«é€Ÿä¸Šæ‰‹ç¯å¢ƒï¼Œåªè¦ä½¿ç”¨ Vagrant å³å¯åˆ›å»ºè™šæ‹Ÿæœºå’Œåº”ç”¨ï¼Œæ‰€ä»¥åœ¨æœ¬ä¹¦çš„[ç¤ºä¾‹ä»£ç ](https://github.com/yangzhares/linkerd-in-action)æœ‰å¤§é‡çš„ Vagrantfileã€‚

![](https://ws4.sinaimg.cn/large/006tNc79ly1fyyav4cxdlj30mu05rwfh.jpg)

æœ¬ä¹¦ç¬¬ä¸‰éƒ¨åˆ†ã€Œå®æˆ˜ç¯‡ã€èŠ±äº†å¤§é‡ç¯‡å¹…ï¼ˆæœ¬ä¹¦ä¸€åŠçš„é¡µæ•°ï¼‰æ¥è®²è§£å¦‚ä½•ä½¿ç”¨ Linkerd å’Œ Kubernetes æ¥ç®¡ç†å¾®æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒæˆ‘2017å¹´8æœˆ1æ—¥å†™çš„è¿™ç¯‡[å¾®æœåŠ¡ç®¡ç†æ¡†æ¶service meshâ€”â€”Linkerdå®‰è£…è¯•ç”¨ç¬”è®°](https://jimmysong.io/posts/linkerd-user-guide/)ï¼Œé‚£æ—¶å€™è¿˜æ˜¯åŸºäº Linkerd 1.1.2ï¼Œè¿˜æœ‰ [Linkerd å®˜æ–¹ç¤ºä¾‹](https://github.com/linkerd/linkerd-examples/)ï¼Œè¿™äº›ç¤ºä¾‹åŸºæœ¬éƒ½ä¸æ€ä¹ˆæ›´æ–°äº†ã€‚

å› ä¸ºè¯¥ä¹¦å®šç¨¿æ—¶æ‰€åŸºäºçš„ Linkerd ç‰ˆæœ¬è·ç¦»æœ¬ä¹¦å‘å”®æ—¶çš„ Linkerd å·²ç»è½åä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼ˆæœ€æ–°ç‰ˆæœ¬æ˜¯ [Linkerd 2.1](https://blog.linkerd.io/2018/12/06/announcing-linkerd-2-1/)ï¼‰ï¼Œæ‰€ä»¥è¯»è€…ä¸€å®šè¦æ³¨æ„è¿™ä¸€ç‚¹ï¼Œè€å®è¯´æˆ‘åªèŠ±äº†ä¸¤ä¸ªå¤œæ™šå¿«é€Ÿè¿‡äº†ä¸€ä¸‹æœ¬ä¹¦ï¼Œæ— æ³•å¯¹æœ¬ä¹¦å†…å®¹ç»™å‡ºå…·ä½“è¯„è®ºï¼Œæ‰€ä»¥æœ¬ä¹¦æ˜¯å¦æ˜¯ä½ æ‰€éœ€è¦çš„å°±è¦ä½ è‡ªå·±å»æ€è€ƒäº†ã€‚

## å‚è€ƒ

- [Envoy é…ç½®è¯¦è§£ - jimmysong.io](https://jimmysong.io/istio-handbook/data-plane/envoy-proxy-config-deep-dive.html)
- [æœåŠ¡ç®¡ç†æ¡†æ¶service meshâ€”â€”Linkerdå®‰è£…è¯•ç”¨ç¬”è®° - jimmysong.io](https://jimmysong.io/posts/linkerd-user-guide/)

